---
id: setup-java-agent
title: Java Agent
---

# Java Agent

Drill4J Java Agent enables metrics collection for JVM-based applications.

## Download

Download <https://github.com/Drill4J/java-agent/releases/tag/v0.9.0> release zip file.

Make sure to download release appropriate for the platform your application is running on:
- Windows - mingwX64
- Linux - linuxX64
- Mac on Intel processors - macosX64
- Mac on Apple Silicon - not supported yet; work in progress

Unzip the file. Rename unzipped folder to `agent`. It must contain `libdrill_agent.so` (or `.dll`, depending on platform), `drill-runtime.jar` and `drill.properties`

## Starting the agent

You have to set [`JAVA_TOOL_OPTIONS`](https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/envvars002.html) env variable to __Java process__ to use Drill4J Java Agent. Its a built-in env variable supported by any Java version

```shell
  # Set JAVA_TOOL_OPTIONS before running your Java app
  JAVA_TOOL_OPTIONS=...
  # This is your application
  java -jar my-app.jar
```

This is the __example string__, see the instructions below:

`JAVA_TOOL_OPTIONS=-agentpath:/agent/libdrill_agent.so=drillInstallationDir=/agent,drillApiUrl=${DRILL_ADMIN_ADDRESS},appId=${DRILL_API_AGENT_ID},groupId=${DRILL_GROUP_ID},drillApiKey=${DRILL_API_KEY},buildVersion=0.1.0,packagePrefixes=io/spring`

This looks overwhelming, lets break it down:

1. `-agentpath:/agent/libdrill_agent.so=drillInstallationDir=/agent` - path to Drill4J Agent files 

    - in case with Windows-based release pass `libdrill_agent.dll` (not .so)

2. `drillApiUrl=` - URL to Drill4J Admin /api endpoint, example: http://my-host-with-drill4j-admin-behind-it.com/api

3. `groupId=` - Unique arbitrary string identifying your application group (e.g. `groupId=my-cool-app`)

4. `appId=` - Unique arbitrary string identifying your application (e.g. `appId=api-service` )

5. `drillApiKey=` - Drill4J Bakend API key. Generate it using Drill4J UI

6. `buildVersion=` - build version of your application. Typically set to version tag (like `v1.2.3`).
  
    - In case you don't have tags for all application builds you can additionally pass `commitSha=` and set it to commit hash value

7. `packagePrefixes=` - topmost common package of your application.

    - For example: if your packages are `"my.org.somecoolapp.user"`, `"my.org.somecoolapp.orders.repository"`, `"my.org.somecoolapp.something.else"`
    - then you set `packagePrefixes=` to `packagePrefixes=my/org/somecoolapp`

## Delivery options

Besides manual download, there are other ways to provide Drill4J Java Agent files to your application.

### CI/CD integration plugin

Drill4J provides plugin for Maven and Gradle to setup and download Java Agent automatically.

It is the preferred way to run Drill4J Java Agent when dealing with __unit and integration test__


### Docker Shared Volume 
When running under Docker it can be handier to use our small image, that runs a script to download these files into shared volume:
```yaml
version: '3.8'
services:

  # The sole function of this container is to download agent files
  # according to version specified in AGENT_VERSION env variable
  # and place them into volume named agent-files
  agent-files:
    image: drill4j/java-agent:0.8.0-38
    environment:
      - AGENT_VERSION=${JAVA_AGENT_VERSION}
    volumes:
      - agent-files:/data
    healthcheck:
      # ensures that container returns "healthy" status only when script is finished downloading files. Mind the .so, swap for .dll for Windows-based enviroments
      test: ["CMD", "sh", "-c", "test -f /data/agent/libdrill_agent.so || exit 1"]
      interval: 30s
      retries: 6
      start_period: 10s
      timeout: 10s

volumes:
  # you can attach this volume to your Application Under Test for ease of access to agent files
  agent-files:
```

### Kubernetes Init Container

When running in Kubernetes consider using [init containers](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/)
to download agent files [from github](https://github.com/Drill4J/java-agent/releases) and make them available for pod running _App Under Test_
