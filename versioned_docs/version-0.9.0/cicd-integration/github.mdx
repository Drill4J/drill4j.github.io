---
id: github
title: Github Integration
---
# Github Integration

import { Image } from '@components';

## Overview

This guide explains how to modify GitHub Actions workflow file to enable Change Testing reports in [Pull Requests](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests) and [workflow artifacts](https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/storing-and-sharing-data-from-a-workflow#about-workflow-artifacts).

This is a step-by-step instruction, make sure to fulfill [prerequisites](#prerequisites) and then follow [steps for integration](#steps-for-integration)

__Change Testing__ report highlights the number of __new__ and __modified__ methods detected by Drill4J, their coverage status, and identifies untested methods that may pose potential __Risks__.

### Report on Pull Requests
1. Identifies changes between __source__ and __target__ branch
2. Displays metrics on how thoroughly __changes__ are tested.
3. Handy for `feature/*`, `fix/*` branches and other shorter-lived branches
4. Attached to [Pull Requests](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests) as comments

<Image alt="GitHub Pull Request Report" src="/img/0.9.0/github/github-pr-report.png" />

### Report on branch push
1. Identifies changes between two commits in __a specific branch__ by comparing current commit with some commit in the past (see [Baseline Strategy](/docs/cicd-integration/cicd-integration-plugin#baseline-strategy))
3. Best used in long-living branches such as `main` and `development`
4. Attached to [artifacts](https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/storing-and-sharing-data-from-a-workflow#about-workflow-artifacts) of workflow triggered [on branch push event](https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#push)

<Image alt="GitHub Workflow Report" src="/img/0.9.0/github/github-workflow-report.png" />

## Prerequisites

1. Familiarity with the [Github Actions](https://docs.github.com/en/actions/writing-workflows)
2. Familiarity with [GitHub secrets and variables](https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository)
3. [Drill4J core services](/docs/getting-started/local-deployment) deployed.

## Steps for integration

1. [Configure Drill4J CI/CD Integration plugin](#configure-drill4j-cicd-integration-plugin)
2. [Configure build step](#modify-build-step-to-send-git-metadata-to-drill4j) to send Git metadata to Drill4J
3. [Configure deployment step](#deploy-the-app-with-drill4j-application-agent) to enable Drill4J Application Agent
4. [Configure tests](#run-tests-with-drill4j-test-agent) to enable Drill4J Test Agent
5. [Generate Change Testing report on Pull request](#generate-report-on-pull-request)
6. [Generate Change Testing report on branch push event](#generate-report-on-branch-push)

## Configure Drill4J CI/CD Integration plugin

1. Follow [CI/CD Integration Plugin - Adding Plugin](/docs/cicd-integration/cicd-integration-plugin#adding-plugin) section to add plugin to your Maven or Gradle project.

2. Generate [API key using Drill4J UI](/docs/drill-services/drill-ui). Save it to [GitHub secrets and variables](https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions) as `DRILL_API_KEY`

3. Create `DRILL_API_URL` variable in [GitHub secrets and variables](https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository). Set its value to Drill4J Admin Backend service API address (e.g. `https://drill4j.my-host.foo/api`). Remember to add `/api` at the end

4. Create [a personal Github access token (classic)](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#creating-a-personal-access-token-classic).
    - Select `repo` scope - that is necessary to post comments on Pull Requests. 
    - Save it to [GitHub secrets and variables](https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository) with the name `DRILL_BOT_GITHUB_TOKEN`. Reports will be posted in comments from the corresponding user

5. Set the following environment variables to GitHub workflow file `env` section:

  ```yml
  env:
    DRILL_API_KEY: ${{ secrets.DRILL_API_KEY }}
    DRILL_API_URL: ${{ vars.DRILL_API_URL }}
    DRILL_BOT_GITHUB_TOKEN: ${{ secrets.DRILL_BOT_GITHUB_TOKEN }}
  ```

## Modify build step to send Git metadata to Drill4J

Modify build step to call __send build info__ command. It submits commit hash, author, and branch associated with build to Drill4J. It is necessary to identify application build in the Drill4J reports and dashboards.

### Gradle

```yml
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Add this only for Pull Requests, see explanations below
          ref: ${{ github.head_ref }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          # adjust for desired Java distribution and version
          distribution: 'temurin'
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # Your build step
      - name: Build app
        run: ./gradlew clean build
  
      # Execute command to send data to Drill4J
      - name: Send build info to Drill4J
        run: ./gradlew drillSendBuildInfo
      
```

### Maven

```yml
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Add this only for Pull Requests, see explanations below
          ref: ${{ github.head_ref }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          # adjust for desired Java distribution and version
          distribution: 'temurin'
          java-version: 17

      # Your build step
      - name: Build app
        run: mvn clean install
  
      # Execute command to send data to Drill4J
      - name: Send build info to Drill4J
        run: ./mvn drill:sendBuildInfo
```

> The `github.head_ref` property instructs `checkout@v4` action to check out the last commit of the branch.
> 
> By default GitHub Pull Requests create __local merge commit__ from target branch to the source branch. It exists only inside workflow environment and is never pushed to remote. That makes it impossible to map it to the rest of repo Git history. 
>
> See GitHub documentation ([#1](https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/accessing-contextual-information-about-workflow-runs) and [#2](https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#pull_request)) and [checkout@v4 Readme](https://github.com/actions/checkout?tab=readme-ov-file#checkout-pull-request-head-commit-instead-of-merge-commit) for more info   

> ðŸš§ TODO: add link to Metabase dashboards to verify Git metadata is submitted and detailed reports are avaialble  ðŸš§

<!-- 4. Once the build information has been successfully submitted, detailed insights will be available in the "Build - Summary" Metabase Dashboard. -->

## Deploy the app with Drill4J Application Agent

### Option 1 - app is launched with Maven or Gradle

1. Setup Application Agent with using [CI/CD Integration Plugin - Application Agent](/docs/cicd-integration/cicd-integration-plugin#application-agent) section

2. Add `DRILL_COMMIT_SHA` env varible following [the instruction below](#add-drill_commit_sha-to-env-variables)

### Option 2 - application is launched as a standalone Java process

1. Add `DRILL_APPLICATION_AGENT_URL` to [GitHub secrets and variables](https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository). Set its value to release .zip from <https://github.com/Drill4J/java-agent/releases> (e.g. `https://github.com/Drill4J/java-agent/releases/download/v0.9.1/agent-linuxX64-0.9.1.zip`)

2. Add the following step to download agent files (above the app launch step):

  ```yml
    - name: Download Drill4J Application Agent
      run: |
        # Download 
        curl -L ${{ vars.DRILL_APPLICATION_AGENT_URL }} -o agent.zip
        # Prep folders
        mkdir -p ./temp-agent-dir /agent
        # Unzip
        unzip agent.zip -d ./temp-agent-dir
        # Move files to /agent folder
        find temp-agent-dir -mindepth 2 -exec mv -t /agent/ {} +
    
    - name: Deploy the application
      run: # your command to deploy application
      env:
        JAVA_TOOL_OPTIONS: -agentpath:/agent/libdrill_agent.so # libdrill_agent.so for linux, libdrill_agent.dylib for Mac, drill_agent.dll for Windows
        # Set Application Agent parameters, see link to reference below
        DRILL_APP_ID: # ...
        DRILL_GROUP_ID: # ...
        DRILL_PACKAGE_PREFIXES: # ...
  ```

  See [Agent Parameters Reference](/docs/agents/java-agent#agent-parameters-reference) for a full list of parameters

3. Set `DRILL_COMMIT_SHA` env varible following [the instruction below](#add-drill_commit_sha-to-env-variables)

### Add DRILL_COMMIT_SHA to env variables

  __For Pull Request__, set it to the `github.event.pull_request.head.sha`:
  ```yml
    - name: Deploy the application
      run: # your command to deploy application
      env:
        # ...
        DRILL_COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
  ```

  __For branch push__ event, set it to `github.sha`:
  ```yml
    - name: Deploy the application
      run: # your command to deploy application
      env:
        # ...
        DRILL_COMMIT_SHA: ${{ github.sha }}
  ```

> ðŸš§ TODO: add link to Metabase dashboards to verify classes and methods information is available  ðŸš§

## Run tests with Drill4J Test Agent

1. Configure Maven or Gradle project to use [Test Agent](/docs/cicd-integration/cicd-integration-plugin#test-agent).

  Once configured, Test Agent is launched with tests tasks automatically.

2. Make sure your tests are launched in Github Action workflow. Usually it looks something like this:

  ```yml
    - name: Run tests
      # Gradle
      run: ./gradlew test
      # or Maven
      # run: ./mvn test
  ```

## Confirm Test Agent and App Agent are working

At this point, with both Application Agent and Test Agent configured, you should be able to push changes to trigger Github Action. That will launch application, execute tests and send metrics to Drill4J.

These metrics will be available in Metabase, make sure to read [Metabase Dashboards](/docs/getting-started/metabase) getting started page.

More specifically you should be able to:
1. See app builds at [Builds](/docs/getting-started/metabase#builds-dashboard) dashboard
2. See metrics for specific build at [Build Summary](/docs/getting-started/metabase#build-summary-dashboard) dashboard, including number of executed tests.
3. See detailed coverage at [Code Coverage](/docs/getting-started/metabase#code-coverage-dashboard) dashboard

Next step is to bring these metrics reports to Pull Request comments and branch push events.

## Generate report on Pull Request

Add additional step to your workflow file:

### Gradle

```yml
jobs:
  # ... all kinds of build and test jobs above ...
  # Add this at the very end of workflow file
  reportByPR:
    if: github.event_name == 'pull_request'
    needs: test  # ensures that tests are completed _before_ this step starts. Adjust name of test step according to your workflow file  # ensures that tests are completed _before_ this step starts. Adjust name of test step according to your workflow file 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0  # required to fetch complete Git history. Report won't work correctly otherwise

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          # adjust for desired Java distribution and version
          distribution: 'temurin'
          java-version: 17
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Send Change Testing report
        run: ./gradlew drillGithubPullRequestReport
```

### Maven
```yml
jobs:
  # ... all kinds of build and test jobs above ...
  # Add this at the very end of workflow file
  reportByPR:
    if: github.event_name == 'pull_request'
    needs: test  # ensures that tests are completed _before_ this step starts. Adjust name of test step according to your workflow file
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0  # required to fetch complete Git history. Report won't work correctly otherwise

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          # adjust for desired Java distribution and version
          distribution: 'temurin'
          java-version: 17
      
      - name: Send Change Testing report
        run: ./mvn drill:githubPullRequestReport
```

### Confirm its working

Open pull request and wait for workflow to complete. Comments section of the Pull Request should have new comment with the report.
<Image alt="GitHub Pull Request Report" src="/img/0.9.0/github/github-pr-report.png" />

## Generate report on Branch push

Add additional step to your workflow file:

### Gradle
```yml
jobs:
  # ... all kinds of build and test jobs above ...
  # Add this at the very end of workflow file
  reportByBranch:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: test  # ensures that tests are completed _before_ this step starts. Adjust name of test step according to your workflow file 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required to fetch complete Git history. Report won't work correctly otherwise
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          # adjust for desired Java distribution and version
          distribution: 'temurin'
          java-version: 17
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Generate Drill4J Change Testing Report
        run: ./gradlew drillGenerateChangeTestingReport

      - name: Attach report
        uses: actions/upload-artifact@v4
        with:
          name: change-testing-report
          path: ./build/drill-reports/drillReport.md
```

### Maven
```yml
jobs:
  # ... all kinds of build and test jobs above ...
  # Add this at the very end of workflow file
  reportByBranch:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: test  # ensures that tests are completed _before_ this step starts. Adjust name of test step according to your workflow file 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required to fetch complete Git history. Report won't work correctly otherwise
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          # adjust for desired Java distribution and version
          distribution: 'temurin'
          java-version: 17

      - name: Generate Drill4J Change Testing Report
        run: ./mvn drill:generateChangeTestingReport

      - name: Attach report
        uses: actions/upload-artifact@v4
        with:
          name: change-testing-report
          path: ./target/drill-reports/drillReport.md
```

### Confirm its working

Push some changes. Once workflow is complete, check the attachments for uploaded report:
<Image alt="GitHub Workflow Report" src="/img/0.9.0/github/github-workflow-report.png" />

## Examples

> ðŸš§ TODO: cleanup example action yml file ðŸš§

You can see example GitHub Drill4J integration in a [demo repository](https://github.com/Drill4J/realworld-spring-webflux) with the following [GitHub Action](https://github.com/Drill4J/realworld-spring-webflux/blob/main/.github/workflows/test.yml)

